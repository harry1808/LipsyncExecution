{% extends "base.html" %}

{% block title %}Evaluation Results - Video Dubbing System{% endblock %}

{% block content %}
<style>
    /* Fix visibility in dark mode */
    .card-body {
        background-color: #ffffff !important;
        color: #000000 !important;
    }
    .card-body p, .card-body div, .card-body span, .card-body strong {
        color: #000000 !important;
    }
    .bg-light {
        background-color: #f8f9fa !important;
        color: #000000 !important;
    }
    .table {
        color: #000000 !important;
    }
    .table th, .table td {
        color: #000000 !important;
    }
</style>
<div class="container mt-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <a href="{{ url_for('main.evaluation_page') }}" class="btn btn-outline-secondary mb-3">
                <i class="bi bi-arrow-left"></i> Back to Evaluation List
            </a>
            <h1 class="display-5">ðŸ“Š Evaluation Results</h1>
            <h4 class="text-muted">{{ activity.filename }}</h4>
            <p class="text-muted">
                <span class="badge bg-secondary">{{ activity.source_lang }}</span>
                <i class="bi bi-arrow-right"></i>
                <span class="badge bg-info">{{ activity.dest_lang }}</span>
            </p>
        </div>
    </div>

    <!-- Overall Score Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-lg border-primary">
                <div class="card-body text-center py-5">
                    <h2 class="card-title mb-3">Overall Quality Score</h2>
                    <div class="display-1 fw-bold text-primary mb-3">
                        {{ "%.1f"|format(results.composite_score) }}<span class="fs-2">/100</span>
                    </div>
                    <div class="mb-3">
                        {% for i in range(5) %}
                            {% if i < results.stars %}
                                <i class="bi bi-star-fill text-warning" style="font-size: 2rem;"></i>
                            {% else %}
                                <i class="bi bi-star text-muted" style="font-size: 2rem;"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <h3 class="
                        {% if results.stars == 5 %}text-success
                        {% elif results.stars == 4 %}text-primary
                        {% elif results.stars == 3 %}text-info
                        {% elif results.stars == 2 %}text-warning
                        {% else %}text-danger
                        {% endif %}
                    ">
                        {{ results.rating }}
                    </h3>
                    <div class="progress mt-3" style="height: 30px;">
                        <div class="progress-bar 
                            {% if results.composite_score >= 90 %}bg-success
                            {% elif results.composite_score >= 75 %}bg-primary
                            {% elif results.composite_score >= 60 %}bg-info
                            {% elif results.composite_score >= 40 %}bg-warning
                            {% else %}bg-danger
                            {% endif %}"
                            role="progressbar" 
                            style="width: {{ results.composite_score }}%"
                            aria-valuenow="{{ results.composite_score }}" 
                            aria-valuemin="0" 
                            aria-valuemax="100">
                            <strong>{{ "%.1f"|format(results.composite_score) }}%</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Component Metrics -->
    <div class="row mb-4">
        <!-- Speech Recognition Results -->
        {% if results.asr %}
        <div class="col-lg-6 mb-4">
            <div class="card h-100 border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-mic"></i> Speech Recognition (ASR)</h5>
                </div>
                <div class="card-body">
                    <!-- WER -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>Word Error Rate (WER)</strong>
                            <span class="badge 
                                {% if results.asr.wer < 10 %}bg-success
                                {% elif results.asr.wer < 20 %}bg-primary
                                {% elif results.asr.wer < 30 %}bg-warning
                                {% else %}bg-danger
                                {% endif %}
                                fs-6">
                                {{ "%.2f"|format(results.asr.wer) }}%
                            </span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar 
                                {% if results.asr.wer < 10 %}bg-success
                                {% elif results.asr.wer < 20 %}bg-primary
                                {% elif results.asr.wer < 30 %}bg-warning
                                {% else %}bg-danger
                                {% endif %}"
                                role="progressbar" 
                                style="width: {{ 100 - results.asr.wer if results.asr.wer < 100 else 0 }}%">
                                Accuracy: {{ "%.1f"|format(results.asr.accuracy) }}%
                            </div>
                        </div>
                        <small class="text-muted">Lower is better (0% = perfect)</small>
                    </div>

                    <!-- CER -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>Character Error Rate (CER)</strong>
                            <span class="badge bg-secondary fs-6">{{ "%.2f"|format(results.asr.cer) }}%</span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-secondary"
                                role="progressbar" 
                                style="width: {{ 100 - results.asr.cer if results.asr.cer < 100 else 0 }}%">
                            </div>
                        </div>
                    </div>

                    <!-- Error Breakdown -->
                    <div class="mb-3">
                        <strong>Error Breakdown:</strong>
                        <table class="table table-sm table-borderless mt-2">
                            <tr>
                                <td>Substitutions:</td>
                                <td class="text-end"><span class="badge bg-warning">{{ results.asr.substitutions }}</span></td>
                            </tr>
                            <tr>
                                <td>Deletions:</td>
                                <td class="text-end"><span class="badge bg-danger">{{ results.asr.deletions }}</span></td>
                            </tr>
                            <tr>
                                <td>Insertions:</td>
                                <td class="text-end"><span class="badge bg-info">{{ results.asr.insertions }}</span></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Text Comparison -->
                    <div class="mt-4">
                        <strong>Ground Truth:</strong>
                        <div class="p-2 bg-light rounded font-monospace small mt-2">
                            {{ results.asr.ground_truth }}
                        </div>
                    </div>
                    <div class="mt-3">
                        <strong>System Output:</strong>
                        <div class="p-2 bg-light rounded font-monospace small mt-2">
                            {{ results.asr.hypothesis }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Translation Results -->
        {% if results.translation %}
        <div class="col-lg-6 mb-4">
            <div class="card h-100 border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-translate"></i> Translation Quality</h5>
                </div>
                <div class="card-body">
                    <!-- BLEU Score -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>BLEU Score</strong>
                            <span class="badge 
                                {% if results.translation.bleu_score > 0.7 %}bg-success
                                {% elif results.translation.bleu_score > 0.5 %}bg-primary
                                {% elif results.translation.bleu_score > 0.3 %}bg-warning
                                {% else %}bg-danger
                                {% endif %}
                                fs-6">
                                {{ "%.4f"|format(results.translation.bleu_score) }}
                            </span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar 
                                {% if results.translation.bleu_score > 0.7 %}bg-success
                                {% elif results.translation.bleu_score > 0.5 %}bg-primary
                                {% elif results.translation.bleu_score > 0.3 %}bg-warning
                                {% else %}bg-danger
                                {% endif %}"
                                role="progressbar" 
                                style="width: {{ results.translation.bleu_score * 100 }}%">
                                {{ "%.1f"|format(results.translation.bleu_score * 100) }}%
                            </div>
                        </div>
                        <small class="text-muted">Higher is better (1.0 = perfect)</small>
                    </div>

                    <!-- N-gram Breakdown -->
                    <div class="mb-4">
                        <strong>N-gram Precision:</strong>
                        <table class="table table-sm mt-2">
                            <thead>
                                <tr>
                                    <th>N-gram</th>
                                    <th>Precision</th>
                                    <th>Visual</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>BLEU-1</td>
                                    <td>{{ "%.4f"|format(results.translation.bleu_1) }}</td>
                                    <td>
                                        <div class="progress" style="height: 15px; width: 100px;">
                                            <div class="progress-bar bg-success" style="width: {{ results.translation.bleu_1 * 100 }}%"></div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>BLEU-2</td>
                                    <td>{{ "%.4f"|format(results.translation.bleu_2) }}</td>
                                    <td>
                                        <div class="progress" style="height: 15px; width: 100px;">
                                            <div class="progress-bar bg-primary" style="width: {{ results.translation.bleu_2 * 100 }}%"></div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>BLEU-3</td>
                                    <td>{{ "%.4f"|format(results.translation.bleu_3) }}</td>
                                    <td>
                                        <div class="progress" style="height: 15px; width: 100px;">
                                            <div class="progress-bar bg-info" style="width: {{ results.translation.bleu_3 * 100 }}%"></div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>BLEU-4</td>
                                    <td>{{ "%.4f"|format(results.translation.bleu_4) }}</td>
                                    <td>
                                        <div class="progress" style="height: 15px; width: 100px;">
                                            <div class="progress-bar bg-warning" style="width: {{ results.translation.bleu_4 * 100 }}%"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Text Comparison -->
                    <div class="mt-4">
                        <strong>Ground Truth:</strong>
                        <div class="p-2 bg-light rounded font-monospace small mt-2">
                            {{ results.translation.ground_truth }}
                        </div>
                    </div>
                    <div class="mt-3">
                        <strong>System Output:</strong>
                        <div class="p-2 bg-light rounded font-monospace small mt-2">
                            {{ results.translation.hypothesis }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Interpretation Guide -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-secondary">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> How to Interpret These Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6><strong>WER (Word Error Rate)</strong></h6>
                            <ul class="small">
                                <li>&lt; 10%: <span class="badge bg-success">Excellent</span></li>
                                <li>10-20%: <span class="badge bg-primary">Good</span></li>
                                <li>20-30%: <span class="badge bg-warning">Fair</span></li>
                                <li>&gt; 30%: <span class="badge bg-danger">Poor</span></li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6><strong>BLEU Score</strong></h6>
                            <ul class="small">
                                <li>&gt; 0.7: <span class="badge bg-success">Good</span></li>
                                <li>0.5-0.7: <span class="badge bg-primary">Acceptable</span></li>
                                <li>0.3-0.5: <span class="badge bg-warning">Fair</span></li>
                                <li>&lt; 0.3: <span class="badge bg-danger">Poor</span></li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6><strong>Overall Score</strong></h6>
                            <ul class="small">
                                <li>90-100: <span class="badge bg-success">Excellent</span></li>
                                <li>75-89: <span class="badge bg-primary">Good</span></li>
                                <li>60-74: <span class="badge bg-info">Fair</span></li>
                                <li>&lt; 60: <span class="badge bg-warning">Needs Work</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="row mb-5">
        <div class="col-12 text-center">
            <a href="{{ url_for('main.activity_detail', activity_id=activity.id) }}" class="btn btn-secondary btn-lg me-2">
                <i class="bi bi-eye"></i> View Activity Details
            </a>
            <a href="{{ url_for('main.evaluation_page') }}" class="btn btn-primary btn-lg">
                <i class="bi bi-arrow-left"></i> Evaluate Another Video
            </a>
        </div>
    </div>
</div>
{% endblock %}

